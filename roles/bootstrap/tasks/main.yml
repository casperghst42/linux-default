  - name: install
    apt:
      state: present
      pkg:
        - sudo
        - bash-completion
        - vim
        - nano
        - python3 
        - python3-pip 
        - python3-setuptools 
        - python3-wheel 
        - python3-pip 
        - openssl 
        - libacl1 
        - build-essential 
        - fuse 
        - locales 
        - curl
        - wget
        - systemd-timesyncd

  - name: default-editor
    command: 
      cmd: update-alternatives --set editor /usr/bin/vim.basic

  - name: default editor vim
    shell:
      cmd: |
        cat <<EOF | tee /etc/profile.d/editor
        EDITOR=vim
        EOF
        chmod 644 /etc/profile.d/editor

  - name: vimrc.local
    shell:
      cmd: |        
        cat <<EOF | tee /etc/vim/vimrc.local > /dev/null

        set tabstop     =4
        set softtabstop =4
        set shiftwidth  =4
        set expandtab

        autocmd BufNewFile,BufReadPost *.{yaml,yml} set filetype=yaml
        autocmd FileType yaml setlocal ts=4 sts=4 sw=4 expandtab

        set is hlsearch ai ic scs
        nnoremap <esc><esc> :nohsl<cr>

        set mouse-=a
        set ttymouse-=a
        EOF

        chmod 644 /etc/vim/vimrc.local

  - name: be-root
    shell:
      cmd: |
        cat <<EOF | tee /usr/local/bin/be-root
        #!/usr/bin/env bash
        sudo su - ${*}
        EOF

        chown root:root /usr/local/bin/be-root
        chmod +x /usr/local/bin/be-root

  - name: environment
    shell:
      cmd: |
        cat << EOF | tee -a /etc/environment
        LANG=en_US.utf-8
        LC_ALL=en_US.utf-8
        EOF

  - name: locale.gen
    shell:
      cmd: |
        cat << EOF | tee -a /etc/locale.gen
        en_US.UTF-8 UTF-8
        EOF

  - name: generate locale
    shell:
      cmd: locale-gen

  - name: services systemd-timesyncd
    systemd:
      name: systemd-timesyncd.service
      state: started   
      enabled: yes
      masked: no

  - name: set tiemzone (europe/copenhagen)
    shell:
      cmd: timedatectl set-timezone Europe/Copenhagen

  - name: is timeserver set
    shell: "egrep -c ^NTP /etc/systemd/timesyncd.conf"
    ignore_errors: yes
    register: timeserver

  - name: add local timeserver
    shell: echo "NTP=192.168.1.1" >> /etc/systemd/timesyncd.conf
    when: timeserver.stdout == "0"

  - name: restart systemd-timesyncd.service
    systemd:
      name: systemd-timesyncd.service
      state: restarted  

  - name: enable NTP
    shell:
      cmd: timedatectl set-ntp true 

  - name: create andible user
    user:
      name: ansible
      state: present        
      shell: /bin/bash
      groups: sudo
      append: yes

  - name: add sshkey to ansible user 
    authorized_key:
      user: ansible
      state: present
      manage_dir: true
      key: "{{ lookup('file', lookup('env','HOME') + '/.ssh/id_rsa.pub') }}"
    
  - name: Add sudo rights for ansible
    copy:
      dest: /etc/sudoers.d/ansible
      content: "ansible ALL=(root) NOPASSWD: ALL"
      backup: true
